{% extends "base.html" %}
{% block content %}

<style>
  /* Featured-style grid tweaks */
  .gs-featured-title {
    color: #c1121f; /* nice Milwaukee-ish red */
    letter-spacing: .5px;
  }
  .gs-product-card {
    height: 100%;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .gs-product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 .5rem 1rem rgba(0,0,0,.08);
  }
  .gs-product-img-wrap {
    height: 170px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
  }
  .gs-product-img {
    max-height: 150px;
    max-width: 100%;
    object-fit: contain;
  }
  .gs-partno {
    color: #c1121f;
    font-weight: 700;
    font-size: .95rem;
  }
  .gs-price {
    font-weight: 700;
  }
  .gs-desc {
    min-height: 44px; /* keeps cards aligned */
  }
</style>

<div class="bg-white border rounded-4 p-4 shadow-sm">
  <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap mb-3">
    <div>
      <h1 class="h4 fw-bold mb-1">{{ t('products_catalog') }}</h1>
      <div class="text-muted small">
        Images load from <code>static/products/&lt;part_number&gt;.png</code>
      </div>
    </div>
    <div class="text-muted small">Total: <span id="gsCount">{{ products|length }}</span></div>
  </div>

  <div class="d-flex gap-2 flex-wrap align-items-center mb-3">
    <div class="flex-grow-1" style="min-width: 240px;">
      <input id="gsSearch" type="text" class="form-control"
             placeholder="Search by part number or description...">
    </div>

    <div style="min-width: 200px;">
      <select id="gsSort" class="form-select">
        <option value="part_asc">Sort: Part # (A → Z)</option>
        <option value="part_desc">Sort: Part # (Z → A)</option>
        <option value="price_asc">Sort: Price (Low → High)</option>
        <option value="price_desc">Sort: Price (High → Low)</option>
      </select>
    </div>
  </div>

  <h2 class="h6 text-center fw-bold gs-featured-title mb-3">Featured Products</h2>

  <!-- Grid -->
  <div id="gsGrid" class="row g-3 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4">
    {% for p in products %}
    <div class="col gs-item"
         data-part="{{ p.part_number|lower }}"
         data-desc="{{ (p.description or '')|lower }}"
         data-price="{{ p.unit_price_mnt }}">
      <div class="card gs-product-card rounded-4">
        <div class="gs-product-img-wrap rounded-top-4 border-bottom">
          <img
            src="{{ url_for('static', filename='products/' ~ p.part_number ~ '.png') }}"
            alt="{{ p.part_number }}"
            class="gs-product-img"
            loading="lazy"
            onerror="this.style.display='none'; this.closest('.gs-product-img-wrap').classList.add('text-muted'); this.closest('.gs-product-img-wrap').innerHTML='<div class=&quot;small text-muted&quot;>No image</div>';"
          >
        </div>

        <div class="card-body">
          <div class="gs-desc text-center fw-semibold">
            {{ p.description }}
          </div>

          <div class="text-center mt-2">
            <div class="gs-partno">({{ p.part_number }})</div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted small">{{ p.uom or '' }}</div>
            <div class="gs-price">{{ "{:,}".format(p.unit_price_mnt) }} MNT</div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if products|length == 0 %}
  <div class="text-muted">No products yet. Run the seed script to import your CSV.</div>
  {% endif %}
</div>

<script>
  (function () {
    const search = document.getElementById("gsSearch");
    const sort = document.getElementById("gsSort");
    const grid = document.getElementById("gsGrid");
    const countEl = document.getElementById("gsCount");

    function getItems() {
      return Array.from(grid.querySelectorAll(".gs-item"));
    }

    function applyFilter() {
      const q = (search.value || "").trim().toLowerCase();
      let visible = 0;

      getItems().forEach(item => {
        const part = item.dataset.part || "";
        const desc = item.dataset.desc || "";
        const ok = !q || part.includes(q) || desc.includes(q);
        item.style.display = ok ? "" : "none";
        if (ok) visible++;
      });

      countEl.textContent = visible.toString();
    }

    function applySort() {
      const items = getItems();
      const mode = sort.value;

      const sorted = items.sort((a, b) => {
        const partA = a.dataset.part || "";
        const partB = b.dataset.part || "";
        const priceA = parseInt(a.dataset.price || "0", 10);
        const priceB = parseInt(b.dataset.price || "0", 10);

        if (mode === "part_asc") return partA.localeCompare(partB);
        if (mode === "part_desc") return partB.localeCompare(partA);
        if (mode === "price_asc") return priceA - priceB;
        if (mode === "price_desc") return priceB - priceA;
        return 0;
      });

      sorted.forEach(item => grid.appendChild(item));
    }

    search.addEventListener("input", applyFilter);
    sort.addEventListener("change", () => { applySort(); applyFilter(); });

    // Initial sort + count
    applySort();
    applyFilter();
  })();
</script>

{% endblock %}
